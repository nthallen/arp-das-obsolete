#! /bin/sh
#__USAGE
#%C <directory> <extraction> [ <extraction> ... ]
#	<directory> is the directory where the extracted
#	spreadsheets are to be found. This would be $analdir
#	if being invoked from reduce.
#
#	<extraction> is a snafu spreadsheet extraction program
#	derived from a .edf file.
#
#	For each spreadsheet generated by each extraction,
#	ext2rtg generates an RTG configuration file to display
#	all of the data extracted. This function relies on
#	the usage message which is derived by edf2ext, and so
#	will not work for extractions which are derived by other
#	means.

function nl_error {
  echo rtgss: $* >&2
  exit 1
}

analdir=`fullpath -t $1`
[ ! -d "$analdir" ] && nl_error Unable to locate directory $1
shift
for ext in ; do
  if [ -x $ext ]; then
	sss=`use $ext | grep "^Spreadsheet" |
	  awk '{ sub( ",$", "", $2 ); print $2 }'`
	for ss in $sss; do
	  [ ! -f $analdir/$ss.sps ] &&
		echo rtgss Warning: $ss.sps not found
	  echo rtgss: Processing Spreadsheet $ss from $ext
	  {
		echo 'PO RP ""'
		echo "PC APC $analdir/$ss.rtg"
		echo 'PA'
		echo "CC sps +$analdir/$ss"
		echo 'CW "Aircraft Status"'
		chans=`use $ext | grep "^  $ss .* = [a-zA-Z0-9_]*\$" | awk '{ print $NF }'`
		#  awk "/$ss .* = [a-zA-Z0-9_]*\$/ { print \$NF }"`
		col=1
		for i in $chans; do
		  echo "CG $i $i "'"" ""'
		  echo "EG"
		  let col=$col+1
		done
		echo "EW"
	  } > $analdir/$ss.rtg
	done
  else
	nl_error Unable to locate extraction $ext
  fi
done
